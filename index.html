<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Seaview Marina Tide Forecast</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: sans-serif; background: #f0f8ff; margin: 20px; }
  h1 { text-align: center; color: #004080; }
  #chartContainer { width: 90%; max-width: 900px; margin: 30px auto; }
  #infoBox {
    text-align: center;
    margin-top: 10px;
    font-size: 18px;
    color: #b30000;
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>Seaview Marina Tide Forecast</h1>
<div id="chartContainer">
  <canvas id="tideChart"></canvas>
</div>
<div id="infoBox"></div>

<script>
// ------------------ ORIGINAL 24-HOUR SAMPLE DATA ------------------
const forecasts = [
  {"time":"2025-11-18T00:00:00","height":1.2},
  {"time":"2025-11-18T01:00:00","height":1.4},
  {"time":"2025-11-18T02:00:00","height":1.6},
  {"time":"2025-11-18T03:00:00","height":1.8},
  {"time":"2025-11-18T04:00:00","height":1.7},
  {"time":"2025-11-18T05:00:00","height":1.5},
  {"time":"2025-11-18T06:00:00","height":1.3},
  {"time":"2025-11-18T07:00:00","height":1.2},
  {"time":"2025-11-18T08:00:00","height":1.4},
  {"time":"2025-11-18T09:00:00","height":1.6},
  {"time":"2025-11-18T10:00:00","height":1.9},
  {"time":"2025-11-18T11:00:00","height":2.1},
  {"time":"2025-11-18T12:00:00","height":2.0},
  {"time":"2025-11-18T13:00:00","height":1.8},
  {"time":"2025-11-18T14:00:00","height":1.6},
  {"time":"2025-11-18T15:00:00","height":1.5},
  {"time":"2025-11-18T16:00:00","height":1.4},
  {"time":"2025-11-18T17:00:00","height":1.3},
  {"time":"2025-11-18T18:00:00","height":1.2},
  {"time":"2025-11-18T19:00:00","height":1.3},
  {"time":"2025-11-18T20:00:00","height":1.5},
  {"time":"2025-11-18T21:00:00","height":1.7},
  {"time":"2025-11-18T22:00:00","height":1.6},
  {"time":"2025-11-18T23:00:00","height":1.4}
];

function processData(forecasts) {
  const labels = [];
  const heights = [];
  const now = new Date();
  let currentIndex = 0;

  forecasts.forEach((f, i) => {
    const t = new Date(f.time);
    labels.push(t.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
    heights.push(f.height);
    if (t > now && currentIndex === 0) currentIndex = i;
  });

  return { labels, heights, currentIndex };
}

const { labels, heights, currentIndex } = processData(forecasts);

function drawChart(labels, heights, currentIndex) {
  const ctx = document.getElementById('tideChart').getContext('2d');

  const tideChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Tide Height (m)',
        data: heights,
        fill: true,
        borderColor: '#007bff',
        backgroundColor: 'rgba(0,123,255,0.2)',
        tension: 0.3,
        pointRadius: 3
      }]
    },
    options: {
      responsive: true,
      plugins: { legend:{display:false}, tooltip:{enabled:false} },
      scales: {
        x: { title: { display:true, text:'Time' } },
        y: {
          title: { display:true, text:'Height (m)' },
          suggestedMin: Math.min(...heights)-0.5,
          suggestedMax: Math.max(...heights)+0.5
        }
      },
      animation:false
    }
  });

  // ---------------- DRAW RED LINE FUNCTION ----------------
  function drawRedLine(index) {
    const chart = tideChart;
    chart.update();
    const ctx2 = chart.ctx;
    const xPixel = chart.scales.x.getPixelForValue(index);

    ctx2.save();
    ctx2.beginPath();
    ctx2.moveTo(xPixel, chart.scales.y.top);
    ctx2.lineTo(xPixel, chart.scales.y.bottom);
    ctx2.strokeStyle = 'red';
    ctx2.lineWidth = 2;
    ctx2.stroke();
    ctx2.restore();
  }

  drawRedLine(currentIndex);

  // ---------------- DRAGGING LOGIC ----------------
  const canvas = tideChart.canvas;
  const infoBox = document.getElementById("infoBox");

  let dragging = false;

  canvas.addEventListener("mousedown", () => dragging = true);
  canvas.addEventListener("mouseup", () => {
    dragging = false;
    infoBox.innerHTML = "";
    drawRedLine(currentIndex); // snap back to NOW
  });

  canvas.addEventListener("mousemove", (e) => {
    if (!dragging) return;

    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const index = Math.round(tideChart.scales.x.getValueForPixel(x));

    if (index >= 0 && index < heights.length) {
      const h = heights[index];
      const rising = heights[index+1] > h ? "Rising" : "Falling";

      infoBox.innerHTML = `${h.toFixed(2)} m â€” ${rising}`;

      drawRedLine(index);
    }
  });

  return tideChart;
}

drawChart(labels, heights, currentIndex);

</script>

</body>
</html>
