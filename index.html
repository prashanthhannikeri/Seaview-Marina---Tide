<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tide Graph</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.0/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 30px;
        max-width: 900px;
    }

    #chart-container {
        height: 350px;
        position: relative;
    }

    #tideTable {
        border-collapse: collapse;
        width: 100%;
        margin-top: 15px;
        display: none; /* Collapsed by default */
    }

    #tideTable th, #tideTable td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: centre;
    }

    #toggleTable {
        background: #007bff;
        padding: 6px 14px;
        border: none;
        border-radius: 6px;
        colour: white;
        cursor: pointer;
        margin-top: 10px;
    }

    #dateContainer {
        margin-bottom: 15px;
    }

    #todayBtn {
        margin-left: 10px;
        padding: 4px 10px;
        background: #28a745;
        colour: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
</style>

</head>
<body>

<h2>Seaview Marina â€“ Tide Chart</h2>

<div id="dateContainer">
    <input type="date" id="datePicker">
    <button id="todayBtn">Today</button>
</div>

<div id="chart-container">
    <canvas id="tideChart"></canvas>
</div>

<button id="toggleTable">Show Table</button>

<table id="tideTable">
    <thead>
        <tr>
            <th>Time</th>
            <th>Height (m)</th>
            <th>Type</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<script>
const CSV_URL = "https://raw.githubusercontent.com/prashanthhannikeri/Seaview-Marina---Tide/refs/heads/main/tide_data%202025.csv";  // <-- Replace with raw GitHub CSV URL
let tideChart = null;

// --- LOAD CSV FUNCTION ---
async function loadCSV() {
    const response = await fetch(CSV_URL);
    const text = await response.text();
    const rows = text.trim().split("\n").slice(1);

    return rows.map(row => {
        const [date, time, height, type] = row.split(",");
        return {
            datetime: `${date}T${time}`,
            date,
            time,
            height: parseFloat(height),
            type
        };
    });
}

// --- FILTER DATA FOR SELECTED DAY ---
function filterByDate(data, selectedDate) {
    return data.filter(d => d.date === selectedDate);
}

// --- CREATE CHART ---
function renderChart(filteredData) {
    const ctx = document.getElementById("tideChart").getContext("2d");

    if (tideChart) tideChart.destroy();

    const now = new Date();

    tideChart = new Chart(ctx, {
        type: "line",
        data: {
            datasets: [
                {
                    label: "Tide Height (m)",
                    data: filteredData.map(d => ({
                        x: d.datetime,
                        y: d.height
                    })),
                    tension: 0.5,     // ðŸ”µ Wave effect (smooth)
                    borderWidth: 2
                },
                {
                    label: "Current Time",
                    data: [
                        { x: now, y: 0 },
                        { x: now, y: 2.5 }
                    ],
                    borderColor: "red",
                    borderWidth: 2,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    min: 0,
                    max: 2.5,
                    title: { display: true, text: "Metres" }
                },
                x: {
                    type: "time",
                    time: {
                        displayFormats: { hour: "HH:mm" }
                    }
                }
            },
            plugins: {
                tooltip: {
                    mode: "nearest",
                    intersect: false,
                    position: "nearest",
                    callbacks: {
                        title: context => "Tide Info",
                        label: context =>
                            `Time: ${new Date(context.parsed.x).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })} | Height: ${context.parsed.y} m`
                    }
                },
                annotation: {}
            }
        }
    });
}

// --- UPDATE TABLE ---
function updateTable(filteredData) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    filteredData.forEach(d => {
        const row = `<tr>
            <td>${d.time}</td>
            <td>${d.height}</td>
            <td>${d.type}</td>
        </tr>`;
        tbody.innerHTML += row;
    });
}

// --- ON DATE CHANGE ---
async function updateGraph() {
    const allData = await loadCSV();
    const selected = document.getElementById("datePicker").value;

    const filtered = filterByDate(allData, selected);

    renderChart(filtered);
    updateTable(filtered);
}

// --- TODAY BUTTON ---
document.getElementById("todayBtn").addEventListener("click", () => {
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("datePicker").value = today;
    updateGraph();
});

// --- TABLE COLLAPSE ---
document.getElementById("toggleTable").addEventListener("click", () => {
    const table = document.getElementById("tideTable");
    if (table.style.display === "none") {
        table.style.display = "table";
        toggleTable.textContent = "Hide Table";
    } else {
        table.style.display = "none";
        toggleTable.textContent = "Show Table";
    }
});

// --- INIT (load today's data) ---
document.addEventListener("DOMContentLoaded", () => {
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("datePicker").value = today;
    updateGraph();
});
</script>

</body>
</html>
