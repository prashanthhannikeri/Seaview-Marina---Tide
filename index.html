<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Seaview Marina Tide Forecast</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: sans-serif; background: #f0f8ff; margin: 20px; }
  h1 { text-align: center; color: #004080; }
  #chartContainer { width: 90%; max-width: 900px; margin: 30px auto; }
  #dragInfo {
    text-align: center;
    font-size: 18px;
    margin-top: 10px;
    color: #b30000;
    font-weight: bold;
  }
</style>
</head>
<body>

<h1>Seaview Marina Tide Forecast</h1>
<div id="chartContainer">
  <canvas id="tideChart"></canvas>
</div>
<div id="dragInfo"></div>

<script>
// ------------------ SAMPLE 24-HOUR DATA ------------------
const forecasts = [
  {"time":"2025-11-18T00:00:00","height":1.2},
  {"time":"2025-11-18T01:00:00","height":1.4},
  {"time":"2025-11-18T02:00:00","height":1.6},
  {"time":"2025-11-18T03:00:00","height":1.8},
  {"time":"2025-11-18T04:00:00","height":1.7},
  {"time":"2025-11-18T05:00:00","height":1.5},
  {"time":"2025-11-18T06:00:00","height":1.3},
  {"time":"2025-11-18T07:00:00","height":1.2},
  {"time":"2025-11-18T08:00:00","height":1.4},
  {"time":"2025-11-18T09:00:00","height":1.6},
  {"time":"2025-11-18T10:00:00","height":1.9},
  {"time":"2025-11-18T11:00:00","height":2.1},
  {"time":"2025-11-18T12:00:00","height":2.0},
  {"time":"2025-11-18T13:00:00","height":1.8},
  {"time":"2025-11-18T14:00:00","height":1.6},
  {"time":"2025-11-18T15:00:00","height":1.5},
  {"time":"2025-11-18T16:00:00","height":1.4},
  {"time":"2025-11-18T17:00:00","height":1.3},
  {"time":"2025-11-18T18:00:00","height":1.2},
  {"time":"2025-11-18T19:00:00","height":1.3},
  {"time":"2025-11-18T20:00:00","height":1.5},
  {"time":"2025-11-18T21:00:00","height":1.7},
  {"time":"2025-11-18T22:00:00","height":1.6},
  {"time":"2025-11-18T23:00:00","height":1.4}
];

function processData(forecasts) {
  const labels = [];
  const heights = [];
  const now = new Date();
  let currentIndex = 0;

  forecasts.forEach((f, i) => {
    const t = new Date(f.time);
    labels.push(t.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
    heights.push(f.height);
    if (t > now && currentIndex === 0) currentIndex = i;
  });

  return { labels, heights, currentIndex };
}

const { labels, heights, currentIndex } = processData(forecasts);

// -------- Create Chart --------
const ctx = document.getElementById('tideChart').getContext('2d');

const tideChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: labels,
    datasets: [{
      label: 'Tide Height (m)',
      data: heights,
      borderColor: '#007bff',
      backgroundColor: 'rgba(0,123,255,0.2)',
      tension: 0.3,
      fill: true,
      pointRadius: 0
    }]
  },
  options: {
    responsive: true,
    animation: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        enabled: false  // We use our own custom tooltip
      }
    },
    scales: {
      x: { title: { display: true, text: "Time" } },
      y: {
        title: { display: true, text: "Height (m)" },
        suggestedMin: Math.min(...heights) - 0.5,
        suggestedMax: Math.max(...heights) + 0.5
      }
    },
    interaction: { mode: "nearest", intersect: false }
  }
});

// ------------------ CUSTOM RED LINE + DRAG LOGIC ------------------
let dragging = false;
let dragIndex = currentIndex;

const dragInfo = document.getElementById("dragInfo");

function drawRedLine(index) {
  const chart = tideChart;
  const ctx = chart.ctx;
  const xPixel = chart.scales.x.getPixelForValue(index);

  chart.update();

  ctx.save();
  ctx.beginPath();
  ctx.moveTo(xPixel, chart.scales.y.top);
  ctx.lineTo(xPixel, chart.scales.y.bottom);
  ctx.strokeStyle = "red";
  ctx.lineWidth = 2;
  ctx.stroke();
  ctx.restore();
}

function updateDragDisplay(index) {
  const h = heights[index];
  const rising = heights[index+1] > h ? "Rising" : "Falling";
  dragInfo.innerHTML = `${h.toFixed(2)} m â€” ${rising}`;
}

function resetToCurrentTime() {
  dragIndex = currentIndex;
  dragInfo.innerHTML = "";
  drawRedLine(dragIndex);
}

// ------------------ Mouse Events ------------------
document.getElementById("tideChart").addEventListener("mousedown", (e) => {
  dragging = true;
});

document.addEventListener("mouseup", () => {
  if (dragging) {
    dragging = false;
    resetToCurrentTime();
  }
});

document.addEventListener("mousemove", (e) => {
  if (!dragging) return;

  const rect = tideChart.canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;

  const scale = tideChart.scales.x;
  const index = Math.round(scale.getValueForPixel(x));

  if (index >= 0 && index < heights.length) {
    dragIndex = index;
    drawRedLine(index);
    updateDragDisplay(index);
  }
});

// ------------ Initial red line ------------
drawRedLine(currentIndex);

// ------------ Update red line every minute ------------
setInterval(() => {
  if (!dragging) {
    const now = new Date();
    let newIndex = currentIndex;
    forecasts.forEach((f, i) => {
      if (new Date(f.time) < now) newIndex = i;
    });
    currentIndex = newIndex;
    drawRedLine(currentIndex);
  }
}, 60000);

</script>
</body>
</html>
