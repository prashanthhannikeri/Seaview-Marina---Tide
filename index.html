<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Seaview Marina Tide Forecast</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    background: #eef7ff;
  }

  #chartWrap {
    width: 90%;
    max-width: 900px;
    margin: 20px auto;
    position: relative;
  }

  canvas {
    background: white;
    border-radius: 8px;
    width: 100% !important;
    height: 380px !important;
  }

  #redline-tooltip {
    position: absolute;
    pointer-events: none;
    opacity: 0;
    transition: 0.1s ease;
  }

  .tooltip-bubble {
    background: #007bff;
    color: white;
    padding: 6px 10px;
    font-size: 12px;
    border-radius: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    white-space: nowrap;
  }

  #tableContainer {
    width: 90%;
    max-width: 900px;
    margin: auto;
  }

  #tideTable {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    display: none;
  }

  #tideTable th, #tideTable td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: center;
    background: white;
  }

  #toggleTable {
    cursor: pointer;
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    margin-top: 10px;
  }
</style>
</head>
<body>

<h2 style="text-align:center;">Seaview Marina Tide Forecast</h2>

<div style="text-align:center; margin-bottom:10px;">
  <input type="date" id="datePicker">
  <button id="todayBtn">Today</button>
</div>

<div id="chartWrap">
  <canvas id="tideChart"></canvas>
  <div id="redline-tooltip"></div>
</div>

<div id="tableContainer">
  <button id="toggleTable">Show Tide Table</button>

  <table id="tideTable">
    <thead>
      <tr>
        <th>Time</th>
        <th>Height (m)</th>
        <th>Trend</th>
      </tr>
    </thead>
    <tbody id="tideBody"></tbody>
  </table>
</div>

<script>
/* -------- CSV URL (replace this with your GitHub RAW link) -------- */
const CSV_URL = "https://raw.githubusercontent.com/yourname/yourrepo/main/tides.csv";

/* -------- Global Vars -------- */
let tideChart = null;
let redLineX = 0;
let currentRedlineHeight = 0;

/* -------- Load CSV -------- */
async function loadCSV() {
  const res = await fetch(CSV_URL);
  const text = await res.text();
  return parseCSV(text);
}

/* -------- Parse CSV Format -------- */
function parseCSV(csv) {
  const lines = csv.trim().split("\n");
  const header = lines.shift().split(",");

  const data = {};

  for (let line of lines) {
    let cols = line.split(",");

    const date = cols[0];
    const time1 = cols[1], tide1 = parseFloat(cols[2]);
    const time2 = cols[3], tide2 = parseFloat(cols[4]);
    const time3 = cols[5], tide3 = parseFloat(cols[6]);
    const time4 = cols[7], tide4 = parseFloat(cols[8]);

    data[date] = [
      { time: time1, height: tide1 },
      { time: time2, height: tide2 },
      { time: time3, height: tide3 },
      { time: time4, height: tide4 }
    ].filter(v => v.time !== "");
  }

  return data;
}

/* -------- Draw Chart -------- */
function drawChart(times, heights, lowHighTimes) {
  if (tideChart) tideChart.destroy();

  const ctx = document.getElementById("tideChart").getContext("2d");

  tideChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: times,
      datasets: [{
        label: "Tide Height",
        data: heights,
        borderColor: "#007bff",
        borderWidth: 2,
        fill: false,
        tension: 0.45,      // â† Wave effect
        pointRadius: 3
      },
      {
        label: "High/Low Tide",
        data: heights.map((h, i) => lowHighTimes.includes(i) ? h : null),
        borderColor: "gold",
        backgroundColor: "gold",
        pointRadius: 6,
        showLine: false
      }]
    },

    options: {
      responsive: true,
      animation: false,

      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: false,
          external: customRedlineTooltip
        }
      },

      scales: {
        y: {
          min: 0,
          max: 2.5,
          title: { display: true, text: "Height (m)" }
        }
      },

      events: ["mousemove", "mouseout", "click", "touchstart", "touchmove"]
    }
  });

  updateRedLine();
}

/* -------- Custom Tooltip (NZ Tide Style) -------- */
function customRedlineTooltip(ctx) {
  const {chart} = ctx;
  const tooltip = document.getElementById("redline-tooltip");

  const yScale = chart.scales.y;

  tooltip.innerHTML = `<div class="tooltip-bubble">${currentRedlineHeight} m</div>`;
  tooltip.style.left = redLineX - 20 + "px";
  tooltip.style.top = yScale.getPixelForValue(currentRedlineHeight) - 40 + "px";
  tooltip.style.opacity = 1;
}

/* -------- Update Red Line Position -------- */
function updateRedLine() {
  const chart = tideChart;
  const now = new Date();

  const times = chart.data.labels;
  const heights = chart.data.datasets[0].data;

  let closestIndex = 0;
  const nowMinutes = now.getHours() * 60 + now.getMinutes();

  times.forEach((t, i) => {
    const [h, m] = t.split(":").map(Number);
    const thisMinutes = h * 60 + m;
    if (thisMinutes <= nowMinutes) closestIndex = i;
  });

  redLineX = chart.scales.x.getPixelForValue(closestIndex);
  currentRedlineHeight = heights[closestIndex];

  drawRedLine();
}

/* -------- Draw Red Line -------- */
function drawRedLine() {
  const chart = tideChart;
  const ctx = chart.ctx;
  const x = redLineX;

  ctx.save();
  ctx.beginPath();
  ctx.moveTo(x, chart.chartArea.top);
  ctx.lineTo(x, chart.chartArea.bottom);
  ctx.strokeStyle = "red";
  ctx.lineWidth = 2;
  ctx.stroke();
  ctx.restore();

  chart.draw();
}

/* -------- Load Data for Selected Date -------- */
async function loadTidesForDate(dateStr) {
  const allData = await loadCSV();
  const entry = allData[dateStr];

  if (!entry) return;

  // sort times
  entry.sort((a,b) => {
    const [h1,m1]=a.time.split(":"); 
    const [h2,m2]=b.time.split(":");
    return h1*60+m1 - (h2*60+m2);
  });

  const times = entry.map(e => e.time);
  const heights = entry.map(e => e.height);

  // detect highs/lows
  const markers = [];
  heights.forEach((h,i)=>{
    if (i>0 && i<heights.length-1) {
      if (h > heights[i-1] && h > heights[i+1]) markers.push(i);
      if (h < heights[i-1] && h < heights[i+1]) markers.push(i);
    }
  });

  drawChart(times, heights, markers);
  fillTable(times, heights);
}

/* -------- Table Fill -------- */
function fillTable(times, heights) {
  const body = document.getElementById("tideBody");
  body.innerHTML = "";

  for (let i = 0; i < times.length; i++) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${times[i]}</td>
      <td>${heights[i]}</td>
      <td>${i>0 ? (heights[i] > heights[i-1] ? "Rising" : "Falling") : "-"}</td>
    `;
    body.appendChild(tr);
  }
}

/* -------- Today Button -------- */
document.getElementById("todayBtn").addEventListener("click", () => {
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("datePicker").value = today;
  loadTidesForDate(today);
});

/* -------- Collapsible Table -------- */
document.getElementById("toggleTable").addEventListener("click", () => {
  const table = document.getElementById("tideTable");
  if (table.style.display === "none") {
    table.style.display = "table";
    toggleTable.innerText = "Hide Tide Table";
  } else {
    table.style.display = "none";
    toggleTable.innerText = "Show Tide Table";
  }
});

/* -------- Initialise with Today -------- */
window.onload = () => {
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("datePicker").value = today;
  loadTidesForDate(today);
};
</script>

</body>
</html>
